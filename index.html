<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Masterplan interactivo - Agreste</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#fff}
    .wrap{display:grid;grid-template-columns:1fr 380px;height:100vh}
    /* ✅ Sin borde negro + fondo claro */
    .stage{background:#ffffff;overflow:hidden;position:relative;user-select:none;-webkit-user-select:none}
    canvas{display:block;width:100%;height:100%;cursor:grab}
    canvas.dragging{cursor:grabbing}
    .panel{background:#fff;border-left:1px solid #e7e7e7;padding:16px;overflow:auto}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    input,select,button{padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px;transition:all 0.2s}
    input,select{flex:1} 
    button{background:#fff;cursor:pointer}
    button:hover{background:#f3f3f3;border-color:#999}
    button:active{transform:scale(0.95)}
    button.zoom-btn{padding:8px 12px;font-size:16px;font-weight:600;min-width:40px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f3f3;font-size:12px;margin-right:6px}
    .muted{color:#6b7280;font-size:12px}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;font-size:14px;margin-top:10px}
    .kv div:first-child{color:#6b7280}
    .warn{background:#fff7ed;border:1px solid #fed7aa;padding:10px;border-radius:12px;margin-top:12px;font-size:12px;color:#7c2d12}
  
    .features{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .feature{display:flex;align-items:center;gap:10px}
    .feature svg{width:22px;height:22px;flex:0 0 22px}
    .feature .label{font-size:13px;color:#111827}
    .feature .subtle{color:#6b7280}

    .zoom-controls{position:absolute;bottom:20px;right:20px;display:flex;flex-direction:column;gap:6px;background:white;padding:8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:100}
    .zoom-level{position:absolute;bottom:80px;right:20px;background:white;padding:8px 12px;border-radius:6px;font-size:12px;font-weight:600;color:#333;box-shadow:0 2px 8px rgba(0,0,0,0.1);z-index:100}

  </style>
</head>
<body>
<div class="wrap">
  <div class="stage">
    <canvas id="c"></canvas>
    <div class="zoom-level" id="zoomLevel">Zoom: 100%</div>
    <div class="zoom-controls">
      <button class="zoom-btn" id="zoomIn" title="Zoom in (+ or scroll up)">+</button>
      <button class="zoom-btn" id="zoomReset" title="Reset zoom (0)">⬜</button>
      <button class="zoom-btn" id="zoomOut" title="Zoom out (- or scroll down)">−</button>
    </div>
  </div>
  <div class="panel">
    <div class="toolbar">
      <input id="search" placeholder="Buscar lote (ej: P01)"/>
      <button id="fit">Ver todo</button>
    </div>
    <div class="toolbar">
      <select id="filter">
        <option value="all">Todos</option>
        <option value="disponible">Disponibles</option>
        <option value="reservado">Reservados</option>
        <option value="vendido">Vendidos</option>
      </select>
      <button id="openAnnot">Marcar lotes</button>
    </div>

    <div id="info">
      <h2 style="margin:0 0 6px 0">Seleccioná un lote</h2>
      <div class="muted">Buscá por código y presioná Enter, o hacé clic cuando el lote tenga polígono.</div>
      <div class="warn"><b>Controles:</b> Rueda para zoom • Clic+arrastrar para mover • Botones + − ⬜ para zoom • Teclado: +/−/0</div>
    </div>

    <div class="muted" style="margin-top:14px">Zoom: rueda • Arrastrar: click y arrastrar</div>
  </div>
</div>

<script src="lotes.js"></script>
<script>
const canvas=document.getElementById("c"), ctx=canvas.getContext("2d");
const img=new Image(); img.src="masterplan.png";

let lots=(typeof LOTES!=="undefined")?LOTES:[];
let selectedId=null, hoveredId=null;

let scale=1, offsetX=0, offsetY=0, dragging=false, drag={sx:0,sy:0,ox:0,oy:0};

const colors={disponible:"rgba(34,197,94,0.18)",reservado:"rgba(234,179,8,0.20)",vendido:"rgba(239,68,68,0.18)",default:"rgba(59,130,246,0.16)"};

// Configuración de zoom mejorada
const ZOOM_CONFIG = {
  min: 0.2,
  max: 15,
  wheelSensitivity: 0.15, // Más sensible
  zoomStep: 1.25 // Botones de zoom
};

function updateZoomDisplay() {
  const percent = Math.round(scale * 100);
  document.getElementById("zoomLevel").textContent = `Zoom: ${percent}%`;
}


const FEATURE_DEFS = {
  vista_mar: {
    label: "Vista al mar",
    svg: `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 15c3-3 6 3 9 0s6 3 9 0" stroke="#1f7a3f" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 11c2-2 4 2 6 0s4 2 6 0" stroke="#1f7a3f" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
          </svg>`
  },
  vista_bodega: {
    label: "Vista a bodega",
    svg: `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 20V11.5L12 7l6 4.5V20" stroke="#1f7a3f" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 20v-4.2c0-1.1.9-2 2-2h2c1.1 0 2 .9 2 2V20" stroke="#1f7a3f" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
            <path d="M10.2 12.2h3.6" stroke="#1f7a3f" stroke-width="1.2" stroke-linecap="round" opacity="0.9"/>
          </svg>`
  },
  monte: {
    label: "Entorno de monte",
    svg: `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 4c3.5 1.5 6 4.2 6 7.2 0 3.1-2.2 5.2-6 5.2s-6-2.1-6-5.2C6 8.2 8.5 5.5 12 4Z" stroke="#1f7a3f" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 16.4V21" stroke="#1f7a3f" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M10.2 21h3.6" stroke="#1f7a3f" stroke-width="1.3" stroke-linecap="round" opacity="0.9"/>
          </svg>`
  },
  piedras: {
    label: "Paisaje rocoso",
    svg: `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 15c-1.7 0-3 1.1-3 2.5S5.3 20 7 20s3-1.1 3-2.5S8.7 15 7 15Z" stroke="#1f7a3f" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 13c-2 0-3.5 1.2-3.5 2.8S14 19 16 19s3.5-1.2 3.5-2.8S18 13 16 13Z" stroke="#1f7a3f" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 17c-1.6 0-2.8.9-2.8 2.1S10.4 21 12 21s2.8-.9 2.8-2.1S13.6 17 12 17Z" stroke="#1f7a3f" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" opacity="0.95"/>
          </svg>`
  },
  altura: {
    label: "Cota elevada",
    svg: `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 17c3-3 5-3 8 0s5 3 10-1" stroke="#1f7a3f" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17 7l1.8 2.6-3.1.1" stroke="#1f7a3f" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" opacity="0.9"/>
          </svg>`
  },
  esquina: {
    label: "Lote esquina",
    svg: `<svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 18V7h11" stroke="#1f7a3f" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 18c-.6 0-1 .4-1 1" stroke="#1f7a3f" stroke-width="1.2" stroke-linecap="round" opacity="0.9"/>
          </svg>`
  }
  // amenities queda para etapa futura
};

function renderFeatures(L){
  const feats = Array.isArray(L.features) ? L.features : [];
  if(!feats.length) return "";
  const items = feats
    .filter(f => FEATURE_DEFS[f])
    .map(f => {
      const d = FEATURE_DEFS[f];
      return `<div class="feature">${d.svg}<div class="label">${d.label}</div></div>`;
    }).join("");
  if(!items) return "";
  return `<div class="features">${items}</div>`;
}


function stageRect(){ return document.querySelector(".stage").getBoundingClientRect(); }

function resize(){
  const st=stageRect();
  const dpr=window.devicePixelRatio||1;
  canvas.width=Math.floor(st.width*dpr);
  canvas.height=Math.floor(st.height*dpr);
  canvas.style.width=st.width+"px";
  canvas.style.height=st.height+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  draw();
}
window.addEventListener("resize", resize);

function fitToScreen(){
  const st=stageRect();
  if(!img.complete) return;
  const pad=0.97; // pequeño margen
  const sx=st.width/img.width;
  const sy=st.height/img.height;
  scale=Math.min(sx,sy)*pad;
  offsetX=(st.width - img.width*scale)/2;
  offsetY=(st.height - img.height*scale)/2;
  updateZoomDisplay();
  draw();
}

function toWorld(x,y){ return {x:(x-offsetX)/scale, y:(y-offsetY)/scale}; }

function pointInPoly(p,poly){
  let inside=false;
  for(let i=0,j=poly.length-1;i<poly.length;j=i++){
    const xi=poly[i].x, yi=poly[i].y, xj=poly[j].x, yj=poly[j].y;
    const hit=((yi>p.y)!=(yj>p.y)) && (p.x < (xj-xi)*(p.y-yi)/(yj-yi+1e-12)+xi);
    if(hit) inside=!inside;
  }
  return inside;
}

function findLotAt(mx,my){
  const w=toWorld(mx,my);
  for(let i=lots.length-1;i>=0;i--){
    const L=lots[i];
    if(L.polygon && L.polygon.length>=3 && pointInPoly(w, L.polygon)) return L.id;
  }
  return null;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!img.complete) return;

  ctx.save();
  ctx.translate(offsetX, offsetY);
  ctx.scale(scale, scale);
  ctx.drawImage(img,0,0);
  ctx.restore();

  const filter=document.getElementById("filter").value;
  const q=document.getElementById("search").value.trim().toUpperCase();

  for(const L of lots){
    const status=(L.status||"disponible");
    if(filter!=="all" && status!==filter) continue;
    if(q && !L.id.toUpperCase().includes(q)) continue;

    if(L.polygon && L.polygon.length>=3){
      const fill=colors[status]||colors.default;
      const stroke=(L.id===selectedId)?"rgba(17,24,39,0.95)"
                  :(L.id===hoveredId)?"rgba(17,24,39,0.65)"
                  :"rgba(17,24,39,0.22)";
      ctx.save();
      ctx.translate(offsetX, offsetY);
      ctx.scale(scale, scale);
      ctx.beginPath();
      L.polygon.forEach((p,idx)=>idx?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
      ctx.closePath();
      ctx.fillStyle=fill;
      ctx.strokeStyle=stroke;
      ctx.lineWidth=(L.id===selectedId||L.id===hoveredId)?3:1.5;
      ctx.fill(); ctx.stroke();
      ctx.restore();
    }
  }
}

function setSelected(id){
  selectedId = id;
  const el = document.getElementById("info");
  const L = lots.find(x => x.id === id);

  if(!L){
    el.innerHTML = `<h2 style="margin:0 0 6px 0">Seleccioná un lote</h2>
      <div class="muted">Buscá por código y Enter, o clic cuando tenga polígono.</div>`;
    draw();
    return;
  }

  const status = (L.status || "disponible");

  el.innerHTML = `
    <h2 style="margin:0 0 6px 0">Lote ${L.id}</h2>

    <div style="margin:8px 0">
      <span class="pill">${status.toUpperCase()}</span>
      <span class="pill">Manzana ${L.manzana || "-"}</span>
    </div>

    
    ${renderFeatures(L)}

    <div class="kv">
<div>Área</div>
      <div>${L.area_m2 ?? "-"} m²</div>

      <div>Estado</div>
      <div>${status.charAt(0).toUpperCase() + status.slice(1)}</div>
    </div>

    ${
      L.tech_plan
        ? `<div style="margin-top:12px">
             <a href="${L.tech_plan}" target="_blank"
                style="display:inline-block;padding:10px 14px;
                       background:#1f7a3f;color:#fff;
                       text-decoration:none;border-radius:8px;">
               Ver plano técnico
             </a>
           </div>`
        : `<div class="muted" style="margin-top:12px">
             Plano técnico: pendiente
           </div>`
    }
  `;

  draw();
}

canvas.addEventListener("mousemove",(e)=>{
  const r=canvas.getBoundingClientRect();
  const id=findLotAt(e.clientX-r.left, e.clientY-r.top);
  hoveredId=id;
  canvas.style.cursor=id?"pointer":(dragging?"grabbing":"grab");
  draw();
});
canvas.addEventListener("click",(e)=>{
  const r=canvas.getBoundingClientRect();
  const id=findLotAt(e.clientX-r.left, e.clientY-r.top);
  if(id) setSelected(id);
});

canvas.addEventListener("mousedown",(e)=>{ dragging=true; drag={sx:e.clientX,sy:e.clientY,ox:offsetX,oy:offsetY}; canvas.classList.add("dragging"); });
window.addEventListener("mouseup",()=>{ dragging=false; canvas.classList.remove("dragging"); });
window.addEventListener("mousemove",(e)=>{ if(!dragging) return; offsetX=drag.ox+(e.clientX-drag.sx); offsetY=drag.oy+(e.clientY-drag.sy); draw(); });

// Zoom mejorado con rueda del ratón
canvas.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const r=canvas.getBoundingClientRect();
  const mx=e.clientX-r.left, my=e.clientY-r.top;
  const before=toWorld(mx,my);
  const factor = Math.exp(-e.deltaY * ZOOM_CONFIG.wheelSensitivity / 100);
  scale=Math.max(ZOOM_CONFIG.min, Math.min(ZOOM_CONFIG.max, scale*factor));
  const after=toWorld(mx,my);
  offsetX += (after.x-before.x)*scale;
  offsetY += (after.y-before.y)*scale;
  updateZoomDisplay();
  draw();
},{passive:false});

// Botones de zoom
function zoomTo(factor, centerX, centerY) {
  const r = canvas.getBoundingClientRect();
  const mx = centerX ?? r.width / 2;
  const my = centerY ?? r.height / 2;
  const before = toWorld(mx, my);
  scale = Math.max(ZOOM_CONFIG.min, Math.min(ZOOM_CONFIG.max, scale * factor));
  const after = toWorld(mx, my);
  offsetX += (after.x - before.x) * scale;
  offsetY += (after.y - before.y) * scale;
  updateZoomDisplay();
  draw();
}

document.getElementById("zoomIn").addEventListener("click", () => zoomTo(ZOOM_CONFIG.zoomStep));
document.getElementById("zoomOut").addEventListener("click", () => zoomTo(1 / ZOOM_CONFIG.zoomStep));
document.getElementById("zoomReset").addEventListener("click", fitToScreen);

// Atajos de teclado
window.addEventListener("keydown", (e) => {
  if(e.target.tagName === "INPUT") return;
  if(e.key === "+") { e.preventDefault(); zoomTo(ZOOM_CONFIG.zoomStep); }
  else if(e.key === "-") { e.preventDefault(); zoomTo(1 / ZOOM_CONFIG.zoomStep); }
  else if(e.key === "0") { e.preventDefault(); fitToScreen(); }
  else if(e.key === "Escape") setSelected(null);
});

document.getElementById("fit").addEventListener("click", fitToScreen);
document.getElementById("filter").addEventListener("change", draw);
document.getElementById("search").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    const q=e.target.value.trim().toUpperCase();
    const L=lots.find(x=>x.id.toUpperCase()===q);
    if(L) setSelected(L.id);
  }
});
document.getElementById("openAnnot").addEventListener("click",()=> window.open("annotator.html","_blank"));

img.onload=()=>{
  resize();
  fitToScreen(); // ✅ mostrar TODO al cargar
  updateZoomDisplay();
};
resize();
updateZoomDisplay();
</script>
</body>
</html>
